<html>
	<head>
		<title>the title</title>
		<style type="text/css">
			.already_played{
				color: grey;
			}
			.current_song{
				background-color:LightBlue;
			}
		</style>
		<script type="text/javascript">
			//global vars
			status=null
			
			//util functions
			function ajax(url,method,postdata,f){
				var xhr = new XMLHttpRequest();
				xhr.onreadystatechange=function(){
					if (xhr.readyState==4 && xhr.status==200){
						f(JSON.parse(xhr.responseText));
					}
				}
				xhr.open(method,url,true);
				xhr.send(postdata);
			}
			function tag_to_id(tag){
				return tag.toLowerCase()+"_selector"
			}
			function obj_to_query_string(obj,base_string){
				if (typeof(obj)=="object"){
					var res=[]
					if (typeof(obj.length)=="undefined"){ // not an array
						if (key_count(obj)==0)
							return base_string;
						for (var i in obj)
							res.push(obj_to_query_string(obj[i],base_string+"["+i+"]"));
					}
					else{ //an array
						if (obj.length==0)
							return base_string;
						for (var i = 0; i<obj.length;i++)
							res.push(obj_to_query_string(obj[i],base_string+"[]")); //same line as above ;)
					}
					return res.join("&");
				}
				else{
					return base_string+"="+encodeURIComponent(obj)
				}
			}
			function key_count(obj){
				count=0;
				for (i in obj) {if (obj.hasOwnProperty(i)) count++;}
				return count;
			}
			function array_include(arr,val){
				for (var i=0; i<arr.length;i++)
					if (arr[i]==val)
						return true;
				return false;
			}
			
			//meat & potatoes
			function update_view(){
				filters=collect_filters();
				var url="/filter?"+obj_to_query_string(filters,"filters")
				
				ajax(url,"GET",null,function(response){
					update_selectors(response,filters);
					document.getElementById("search_box").value="";
				})
			}
			function update_selectors(data,filters){
				all_data=data
				for (tag in data){
					var e=document.getElementById(tag_to_id(tag));
					//e.options.length=0;
					e.innerHTML=""
					for (var i=0;i<data[tag].length;i++){
						//possibly factor this out later...
						if (tag=="Tracks"){
							var fname=data[tag][i]["file"]
							var title=data[tag][i]["Title"] || "(Unknown Title, file="+fname+")"
							e.add(new Option(title,fname))
						}
						else{
							var val=data[tag][i];
							var inc=false;
							if (typeof(filters[tag])!="undefined"){
								inc=array_include(filters[tag],val||"");
							}
							if (val)
								var o=new Option(val,val,inc,inc);
							else
								var o=new Option("(Unknown "+tag+")","",inc,inc)
							e.add(o);
							if (inc)
								o.selected="true"
						}
					}
				}
			}
			function collect_filters(){
				var all={};
				var tags=["Genre","Artist","Album"]
				for (var i in tags){
					var tag=tags[i]
					all[tag]=[];
					var e=document.getElementById(tag_to_id(tag));
					for (var i=0; i<e.options.length; i++)
						if(e.options[i].selected)
							all[tag].push(e.options[i].value);
					//if (all[tag].length==0)
					//	delete all[tag];
				}
				return all;
			}
			function update_status(){
				ajax("/status","GET",null,function(data){
					var ul=document.getElementById("status_list")
					ul.innerHTML=""
					for (var i in data){
						var li=document.createElement("li")
						li.textContent=i+": "+data[i]
						ul.appendChild(li)
					}
					if (status.queue_version!=data.queue_version){
						update_queue(data.song);
					}
					document.getElementById("vol").value=data.volume;
					
					//now that comparisons are done, use this
					status=data;
				});
			}
			function update_queue(song_i){
				ajax("/queue/list","GET",null,function(data){
					var ul = document.getElementById("queue_list");
					ul.innerHTML="";
					for (var i=0; i<data.length; i++){
						var li=document.createElement("li");
						var track=data[i];
						li.textContent=(track["Artist"]||"(Unknown Artist)")+" - "+(track["Title"]||"(Unknown Title, file="+track["file"]+")")
						if (i<song_i)
							li.className="already_played"
						if (i==song_i)
							li.className="current_song"
						ul.appendChild(li);
					}
				});
			}
			function simple_control(url,method){
				ajax(url,method,null,function(d){update_status();});
			}
			function add_tracks(){
				
				var e=document.getElementById("tracks_selector")
				for (var i=0; i<e.options.length; i++){
					if (e.options[i].selected){
						ajax("/queue/add?filename="+encodeURIComponent(e.options[i].value),"post",null,function(d){})
					}
				}
				update_status();
			}
			timeout_id=null
			function debounce_search(){
				if (timeout_id)
					clearTimeout(timeout_id)
				timeout_id=setTimeout(function(){
					do_search(document.getElementById("search_box").value);
				},250);
			}
			function do_search(query){
				ajax("/search/"+encodeURIComponent(query),"GET",null,function(d){
					update_selectors({Tracks: d});
				});
			}
			window.onload=function(){
				var arr=document.getElementsByClassName("filter_selector");
				for (var i in arr){
					arr[i].onchange=update_view;
				}
				update_view();
				update_status();
				setInterval(update_status,10*1000)
			}
		</script>
			
	</head>	
<body>
<body>
	<div id="controls">
		<h2>Controls</h2>
		<a href="#" onclick="simple_control('/queue/clear','put');">clear queue</a>
		<a href="#" onclick="simple_control('/playback/play','put');">play from beginning</a>
		<a href="#" onclick="simple_control('/playback/previous','post');">previous</a>
		<a href="#" onclick="simple_control('/playback/next','post');">next</a>
		<label for="vol">Volume</label><input id="vol" type="text" onchange="simple_control('/playback/setvol?vol='+this.value,'put');"/>
	</div>
	<select multiple="true" class="filter_selector" id="genre_selector"></select>
	<select multiple="true" class="filter_selector" id="artist_selector"></select>
	<select multiple="true" class="filter_selector" id="album_selector" ondblclick="add_tracks();"></select>
	<select multiple="true" id="tracks_selector" ondblclick="add_tracks()"></select>
	<a href="#" onclick="add_tracks()">Add Selected Tracks</a>
	<label for="search_box">search</label><input id="search_box" type="text" onchange="debounce_search();" onkeydown="debounce_search();"/>
	<div id="status">
		<h2>status</h2>
		<ul id="status_list"></ul>
	</div>
	<div id="queue">
		<h2>queue</h2>
		<ul id="queue_list"></ul>
	</div>
</body>